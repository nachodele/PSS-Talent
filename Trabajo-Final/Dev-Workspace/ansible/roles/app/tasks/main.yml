---
- name: Actualizar cache APT
  become: true
  apt:
    update_cache: yes

- name: Instalar python3-pip PRIMERO
  become: true
  apt:
    name: python3-pip
    state: present

- name: Instalar python3-dev
  become: true
  apt:
    name: python3-dev
    state: present

- name: Instalar librería docker para Ansible
  become: true
  ansible.builtin.pip:
    name: docker
    state: present

- name: Fijar versiones compatibles de docker y requests
  become: true
  ansible.builtin.pip:
    name:
      - "docker<7.0.0"
      - "requests<2.32.0"
    state: present

- name: Instalar Docker
  become: true
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - docker.io
    state: present

- name: Agregar usuario ubuntu al grupo docker
  become: true
  user:
    name: ubuntu
    groups: docker
    append: yes

- name: Iniciar y habilitar Docker service
  become: true
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Esperar a que Docker esté listo
  become: true
  wait_for:
    path: /var/run/docker.sock
    state: present
    timeout: 30

- name: Crear carpeta base de la app
  become: true
  ansible.builtin.file:
    path: "{{ app_base_dir }}"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: "0755"

- name: Clonar o actualizar repositorio
  ansible.builtin.git:
    repo: "{{ app_repo_url }}"
    dest: "{{ app_base_dir }}/repo"
    version: "{{ app_repo_version }}"
    update: true

- name: Copiar código al directorio de build
  become: true
  ansible.builtin.copy:
    src: "{{ app_base_dir }}/repo/{{ app_repo_subdir }}/"
    dest: "{{ app_base_dir }}/app/"
    owner: ubuntu
    group: ubuntu
    mode: "0755"
    remote_src: true

- name: Construir imagen Docker
  community.docker.docker_image:
    name: "{{ app_image_name }}"
    build:
      path: "{{ app_base_dir }}/app"
    source: build
    state: present

- name: Asegurar contenedor ejecutándose
  community.docker.docker_container:
    name: "{{ app_container_name }}"
    image: "{{ app_image_name }}:latest"
    state: started
    recreate: true
    restart_policy: always
    published_ports:
      - "80:{{ app_container_port }}"
