---
- name: Instalar librerías Python para Docker Ansible
  become: true
  ansible.builtin.pip:
    name:
      - "docker<7.0.0"
      - "requests<2.32.0"
    state: present

- name: Esperar a que Docker socket esté disponible
  become: true
  ansible.builtin.wait_for:
    path: /var/run/docker.sock
    state: present
    timeout: 30

- name: Crear carpeta base de la app
  become: true
  ansible.builtin.file:
    path: "{{ app_base_dir }}"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Clonar/actualizar repositorio
  ansible.builtin.git:
    repo: "{{ app_repo_url }}"
    dest: "{{ app_base_dir }}/repo"
    version: "{{ app_repo_version }}"
    update: true

- name: Construir imagen Docker
  become: true
  ansible.builtin.shell: docker build -t {{ app_image_name }} "{{ app_base_dir }}/repo/{{ app_repo_subdir }}"

- name: Asegurar contenedor ejecutándose (IDEMPOTENTE)
  become: true
  ansible.builtin.shell: |
    if ! docker ps --format "table {{ '{{' }}.Names}}" | grep -q "{{ app_container_name }}"; then
      echo "Iniciando contenedor {{ app_container_name }}..."
      docker stop {{ app_container_name }} || true
      docker rm {{ app_container_name }} || true
      docker run -d \
        --name {{ app_container_name }} \
        --restart unless-stopped \
        -p 80:{{ app_container_port }} \
        -e PR_ID="{{ app_repo_version }}" \
        -e GIT_SHA="{{ app_repo_version }}" \
        {{ app_image_name }}
      echo " Contenedor {{ app_container_name }} INICIADO"
    else
      echo " Contenedor {{ app_container_name }} ya ejecutándose"
    fi
  changed_when: false