---
- name: Instalar librerías Python para Docker Ansible
  become: true
  ansible.builtin.pip:
    name:
      - "docker<7.0.0"
      - "requests<2.32.0"
    state: present

- name: Esperar a que Docker socket esté disponible
  become: true
  ansible.builtin.wait_for:
    path: /var/run/docker.sock
    state: present
    timeout: 30

- name: Crear carpeta base de la app
  become: true
  ansible.builtin.file:
    path: "{{ app_base_dir }}"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Clonar/actualizar repositorio
  ansible.builtin.git:
    repo: "{{ app_repo_url }}"
    dest: "{{ app_base_dir }}/repo"
    version: "{{ app_repo_version }}"
    update: true

- name: Copiar código al directorio de build
  become: true
  ansible.builtin.synchronize:
    src: "{{ app_base_dir }}/repo/{{ app_repo_subdir }}/"
    dest: "{{ app_base_dir }}/app/"
    delete: true
    recursive: true
    rsync_opts:
      - "--chown=ubuntu:ubuntu"
      - "--chmod=0755"

- name: Construir imagen Docker
  community.docker.docker_image:
    name: "{{ app_image_name }}"
    build:
      path: "{{ app_base_dir }}/app"
    source: build
    state: present

- name: Asegurar contenedor ejecutándose
  community.docker.docker_container:
    name: "{{ app_container_name }}"
    image: "{{ app_image_name }}:latest"
    state: started
    recreate: true
    restart_policy: always
    published_ports:
      - "80:{{ app_container_port }}"
    env:
      PR_ID: "{{ app_repo_version }}"
      GIT_SHA: "{{ app_repo_version }}"
